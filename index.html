const firebaseConfig = {
  apiKey: "AIzaSyB-ldnW85PPEL3Y4SAbWEotRvmTLtzgq8o",
  authDomain: "task-75413.firebaseapp.com",
  projectId: "task-75413",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const days = ["Th·ª© 2","Th·ª© 3","Th·ª© 4","Th·ª© 5","Th·ª© 6","Th·ª© 7","CN"];

function addTask() {
  const name = document.getElementById("nameInput").value.trim();
  const day = document.getElementById("dayInput").value;
  const text = document.getElementById("taskInput").value.trim();

  if (!name || !text) {
    alert("Nh·∫≠p ƒë·ªß t√™n v√† nhi·ªám v·ª•");
    return;
  }

  db.collection("tasks").add({
    name,
    day,
    text,
    done: false,
    createdAt: Date.now() // üî• FIX: kh√¥ng d√πng serverTimestamp
  });

  document.getElementById("taskInput").value = "";
}

// üî• KH√îNG orderBy
db.collection("tasks").onSnapshot(snapshot => {
  const data = {};

  snapshot.forEach(doc => {
    const d = doc.data();
    if (!data[d.name]) data[d.name] = {};
    if (!data[d.name][d.day]) data[d.name][d.day] = [];
    data[d.name][d.day].push({ id: doc.id, ...d });
  });

  renderTable(data);
});

function renderTable(data) {
  const body = document.getElementById("tableBody");
  body.innerHTML = "";

  Object.keys(data).forEach(name => {
    const tr = document.createElement("tr");

    const nameTd = document.createElement("td");
    nameTd.innerHTML = `<b>${name}</b>`;
    tr.appendChild(nameTd);

    days.forEach(day => {
      const td = document.createElement("td");

      (data[name][day] || []).forEach(t => {
        const div = document.createElement("div");
        div.innerHTML = `
          <input type="checkbox" ${t.done ? "checked" : ""}
            onchange="toggleDone('${t.id}', this.checked)">
          <span style="${t.done ? "text-decoration:line-through" : ""}">
            ${t.text}
          </span>
          <button onclick="deleteTask('${t.id}')">‚ùå</button>
        `;
        td.appendChild(div);
      });

      tr.appendChild(td);
    });

    body.appendChild(tr);
  });
}

function toggleDone(id, value) {
  db.collection("tasks").doc(id).update({ done: value });
}

function deleteTask(id) {
  if (confirm("Xo√° nhi·ªám v·ª•?")) {
    db.collection("tasks").doc(id).delete();
  }
}
